<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>GRASS GIS manual: i.hyper.atcorr</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" href="grassdocs.css" type="text/css">
</head>
<body bgcolor="white">
<div id="container">

<a href="index.html"><img src="grass_logo.png" alt="GRASS logo"></a>
<hr class="header">

<h2>NAME</h2>
<em><b>i.hyper.atcorr</b></em> - Atmospheric correction of hyperspectral imagery
using the 6SV2.1 radiative transfer algorithm with ISOFIT-inspired improvements.

<h2>KEYWORDS</h2>
<a href="imagery.html">imagery</a>,
<a href="topic_atmospheric_correction.html">atmospheric correction</a>,
<a href="topic_radiative_transfer.html">radiative transfer</a>,
6SV, hyperspectral, LUT, ISOFIT, uncertainty

<h2>SYNOPSIS</h2>
<div id="name"><b>i.hyper.atcorr</b><br></div>
<b>i.hyper.atcorr --help</b><br>
<div id="synopsis"><b>i.hyper.atcorr</b>
[<b>-ur</b>]
[<b>input</b>=<em>name</em>]
[<b>output</b>=<em>name</em>]
[<b>lut</b>=<em>name</em>]
<b>sza</b>=<em>float</em>
[<b>vza</b>=<em>float</em>]
[<b>raa</b>=<em>float</em>]
[<b>altitude</b>=<em>float</em>]
[<b>doy</b>=<em>integer</em>]
[<b>atmosphere</b>=<em>string</em>]
[<b>aerosol</b>=<em>string</em>]
[<b>ozone</b>=<em>float</em>]
[<b>aod</b>=<em>values</em>]
[<b>h2o</b>=<em>values</em>]
[<b>wl_min</b>=<em>float</em>]
[<b>wl_max</b>=<em>float</em>]
[<b>wl_step</b>=<em>float</em>]
[<b>aod_val</b>=<em>float</em>]
[<b>h2o_val</b>=<em>float</em>]
[<b>aod_map</b>=<em>name</em>]
[<b>h2o_map</b>=<em>name</em>]
[<b>smooth</b>=<em>float</em>]
[<b>adj_psf</b>=<em>float</em>]
[<b>pixel_size</b>=<em>float</em>]
[<b>uncertainty</b>=<em>name</em>]
[<b>brdf</b>=<em>string</em>]
[<b>brdf_params</b>=<em>values</em>]
[<b>-awz</b>]
[<b>dem</b>=<em>name</em>]
[--<b>verbose</b>]
[--<b>help</b>]
</div>

<h3>Flags:</h3>
<dl>
<dt><b>-u</b></dt>
<dd>Compute per-band, per-pixel reflectance uncertainty (#4)</dd>
<dt><b>-r</b></dt>
<dd>Apply surface prior MAP regularisation after all bands are inverted (#3/#5/#6)</dd>
<dt><b>--verbose</b></dt>
<dd>Print summary statistics after LUT computation</dd>
<dt><b>--help</b></dt>
<dd>Print usage summary</dd>
</dl>

<h3>Parameters:</h3>
<dl>
<dt><b>input</b>=<em>name</em></dt>
<dd>Input TOA radiance Raster3D cube in W/(m&sup2; sr &micro;m)</dd>

<dt><b>output</b>=<em>name</em></dt>
<dd>Output BOA surface reflectance Raster3D cube</dd>

<dt><b>lut</b>=<em>name</em></dt>
<dd>Binary LUT file: written when generating, read when correcting (or both)</dd>

<dt><b>sza</b>=<em>float</em> <b>[required]</b></dt>
<dd>Solar zenith angle in degrees (0 to &lt;90)</dd>

<dt><b>vza</b>=<em>float</em></dt>
<dd>Sensor view zenith angle in degrees (0&ndash;60); default: <tt>0</tt></dd>

<dt><b>raa</b>=<em>float</em></dt>
<dd>Relative azimuth angle between sun and sensor in degrees; default: <tt>0</tt></dd>

<dt><b>altitude</b>=<em>float</em></dt>
<dd>Sensor altitude in km; values &gt;900 treated as satellite; default: <tt>1000</tt></dd>

<dt><b>doy</b>=<em>integer</em></dt>
<dd>Day of year for Earth-Sun distance correction (1&ndash;365); default: <tt>180</tt></dd>

<dt><b>atmosphere</b>=<em>string</em></dt>
<dd>Standard atmosphere model; options: <tt>us62</tt>, <tt>midsum</tt>,
<tt>midwin</tt>, <tt>tropical</tt>, <tt>subsum</tt>, <tt>subwin</tt>;
default: <tt>us62</tt></dd>

<dt><b>aerosol</b>=<em>string</em></dt>
<dd>Aerosol type; options: <tt>none</tt>, <tt>continental</tt>,
<tt>maritime</tt>, <tt>urban</tt>, <tt>desert</tt>;
default: <tt>continental</tt></dd>

<dt><b>ozone</b>=<em>float</em></dt>
<dd>Total ozone column in Dobson units; default: <tt>300</tt></dd>

<dt><b>aod</b>=<em>values</em></dt>
<dd>Comma-separated AOD at 550&nbsp;nm values for the LUT grid;
default: <tt>0.0,0.05,0.1,0.2,0.4,0.8</tt></dd>

<dt><b>h2o</b>=<em>values</em></dt>
<dd>Comma-separated column water vapour values (g/cm&sup2;) for the LUT grid;
default: <tt>0.5,1.0,2.0,3.5,5.0</tt></dd>

<dt><b>wl_min</b>=<em>float</em></dt>
<dd>Minimum wavelength in micrometres; default: <tt>0.40</tt></dd>

<dt><b>wl_max</b>=<em>float</em></dt>
<dd>Maximum wavelength in micrometres; default: <tt>2.50</tt></dd>

<dt><b>wl_step</b>=<em>float</em></dt>
<dd>Wavelength step in micrometres; default: <tt>0.01</tt></dd>

<dt><b>aod_val</b>=<em>float</em></dt>
<dd>Scene-average AOD at 550&nbsp;nm (scalar fallback when no aod_map); default: <tt>0.1</tt></dd>

<dt><b>h2o_val</b>=<em>float</em></dt>
<dd>Scene-average column water vapour g/cm&sup2; (scalar fallback when no h2o_map); default: <tt>2.0</tt></dd>

<dt><b>aod_map</b>=<em>name</em></dt>
<dd>Per-pixel AOD raster map (2-D); overrides aod_val when provided (#1)</dd>

<dt><b>h2o_map</b>=<em>name</em></dt>
<dd>Per-pixel column water vapour raster map g/cm&sup2; (2-D); overrides h2o_val when provided (#1)</dd>

<dt><b>smooth</b>=<em>float</em></dt>
<dd>Gaussian smoothing &sigma; in pixels applied to aod_map/h2o_map before correction; 0 = off (#1)</dd>

<dt><b>adj_psf</b>=<em>float</em></dt>
<dd>Adjacency effect PSF radius in km (Vermote 1997); 0 = off (#2); default: <tt>0</tt></dd>

<dt><b>pixel_size</b>=<em>float</em></dt>
<dd>Pixel size in metres for adjacency correction; 0 = auto-detect from GRASS region (#2)</dd>

<dt><b>uncertainty</b>=<em>name</em></dt>
<dd>Output per-pixel reflectance uncertainty Raster3D; requires -u flag (#4)</dd>

<dt><b>brdf</b>=<em>string</em></dt>
<dd>Surface BRDF model; options: <tt>lambertian</tt>, <tt>rahman</tt>,
<tt>roujean</tt>, <tt>hapke</tt>, <tt>ocean</tt>, <tt>walthall</tt>,
<tt>minnaert</tt>, <tt>rosslimaignan</tt>; default: <tt>lambertian</tt></dd>

<dt><b>brdf_params</b>=<em>values</em></dt>
<dd>Comma-separated BRDF model parameters (see C Library API section for
per-model parameter order); default: <tt>1.0</tt> (Lambertian reflectance)</dd>

<dt><b>-a</b></dt>
<dd>Retrieve per-pixel AOD at 550&nbsp;nm from Dark Dense Vegetation (DDV) pixels
using the MODIS dark-target algorithm (470/660/860/2130&nbsp;nm bands).
Updates <tt>aod_val=</tt> with the scene mean. Requires <tt>input=</tt> with wavelength metadata.</dd>

<dt><b>-w</b></dt>
<dd>Retrieve per-pixel column water vapour [g/cm&sup2;] from the 940&nbsp;nm absorption
feature (continuum interpolation: 865/940/1040&nbsp;nm).
Updates <tt>h2o_val=</tt> with the scene mean. Requires <tt>input=</tt> with wavelength metadata.</dd>

<dt><b>-z</b></dt>
<dd>Retrieve scene-mean O<sub>3</sub> column [DU] from the Chappuis absorption feature
(continuum: 540/600/680&nbsp;nm). Updates <tt>ozone=</tt> for LUT computation.
Requires <tt>input=</tt> with wavelength metadata.</dd>

<dt><b>dem</b>=<em>name</em></dt>
<dd>2-D elevation raster [m above sea level]. Scene-mean elevation is converted
to ISA surface pressure and used in LUT computation, overriding the
standard-atmosphere sea-level default.</dd>
</dl>

<h2>DESCRIPTION</h2>

<em>i.hyper.atcorr</em> is a GRASS GIS add-on for atmospheric correction of
hyperspectral imagery. It operates in two complementary modes that can be
combined in a single invocation:

<ul>
  <li><b>LUT generation</b> (<tt>lut=</tt>): compute a binary look-up table of
      atmospheric parameters over an [AOD &times; H<sub>2</sub>O &times; wavelength] grid.</li>
  <li><b>Cube correction</b> (<tt>input=</tt> / <tt>output=</tt>): apply the LUT
      to a Raster3D radiance cube, writing a surface (BOA) reflectance cube.</li>
</ul>

<p>
The LUT is computed using a C port of the 6SV2.1 (Second Simulation of
a Satellite Signal in the Solar Spectrum, version 2.1) radiative transfer code
with OpenMP parallelisation over the AOD dimension.
</p>

<p>
For each (AOD, H<sub>2</sub>O, &lambda;) grid point the module stores four
atmospheric parameters:
</p>
<ul>
  <li><b>R_atm</b> &mdash; atmospheric path reflectance</li>
  <li><b>T_down</b> &mdash; total downward transmittance (direct + diffuse)</li>
  <li><b>T_up</b> &mdash; total upward transmittance (direct + diffuse)</li>
  <li><b>s_alb</b> &mdash; spherical albedo of the atmosphere</li>
</ul>

<p>
Inversion from TOA radiance <em>L</em> to BOA reflectance uses the standard
6SV formula:
</p>
<pre>
  &rho;_toa = (&pi; &times; L &times; d&sup2;) / (E&sub0; &times; cos &theta;_s)
  &rho;_boa = (&rho;_toa &minus; R_atm) / (T_down &times; T_up &times; (1 + s_alb &times; &rho;_boa))
</pre>
<p>
where <em>E&sub0;</em> is the Thuillier solar irradiance (from 6SV2.1 tables) and
<em>d&sup2;</em> is the squared Earth-Sun distance for the acquisition day-of-year.
</p>

<h2>ISOFIT-INSPIRED IMPROVEMENTS</h2>

<p>
Six improvements inspired by the
<a href="https://github.com/isofit/isofit">ISOFIT</a> framework are available
as optional flags and parameters. They can be combined freely; each defaults
to disabled for full backward compatibility.
</p>

<h3>#1 &mdash; Per-pixel atmospheric maps + spatial smoothing</h3>

<p>
Supply 2-D raster maps of AOD (at 550&nbsp;nm) and/or column water vapour
(g/cm&sup2;) derived from Dark Target, MAIAC, or any retrieval product.
Per-pixel values replace the scalar <tt>aod_val=</tt> / <tt>h2o_val=</tt>
fallbacks; each pixel is corrected using trilinear LUT interpolation at its
own (aod, h2o, &lambda;) point.
</p>
<p>
<tt>smooth=</tt> applies a <b>separable Gaussian filter</b> (&sigma; in pixels)
to the maps before correction, suppressing retrieval noise while preserving
large-scale spatial gradients. Boundary pixels use edge-replication padding;
NaN/null pixels are excluded from the neighbourhood average.
</p>

<h3>#2 &mdash; In-loop adjacency effect correction</h3>

<p>
Applies the <b>Vermote et al. (1997) adjacency correction</b> per band
immediately after algebraic inversion, before spectral regularisation.
The diffuse transmittance fraction carries signal from a spatially-averaged
environmental neighbourhood reflectance:
</p>
<pre>
  T_diff = clip(T_scat &minus; T_dir, 0, T_scat)
  r_env  = box_filter(r_boa, radius = adj_psf / pixel_size)
  r_boa += T_diff &times; s_alb &times; (r_boa &minus; r_env) / (1 &minus; s_alb &times; r_env)
</pre>
<p>
<tt>T_dir</tt> is the Beer-Lambert two-way direct transmittance from Rayleigh
+ aerosol optical depths. <tt>pixel_size=</tt> is auto-detected from the GRASS
computational region if not given.
</p>

<h3>#3 &amp; #5 &mdash; Surface prior MAP regularisation (<tt>-r</tt> flag)</h3>

<p>
After all bands have been inverted, blends each pixel's retrieved spectrum
with a <b>3-component Gaussian mixture surface prior</b> (vegetation, soil,
water) using diagonal-covariance MAP estimation:
</p>
<pre>
  r_map[b] = (r_obs[b] / &sigma;_obs&sup2;[b]  +  r_prior[b] / &sigma;_prior&sup2;[b])
             / (1/&sigma;_obs&sup2;[b]  +  1/&sigma;_prior&sup2;[b])
</pre>
<p>
Each pixel is classified to the nearest component using VNIR bands
(0.40&ndash;1.00&nbsp;&micro;m). Prior means are hardcoded reference spectra interpolated
to the sensor wavelengths; prior variances scale as <tt>(scale &times; mean)&sup2;</tt>
(vegetation 15&nbsp;%, soil 20&nbsp;%, water 3&nbsp;%). The <tt>-r</tt> flag requires loading
the full reflectance cube into memory (~400&nbsp;MB for a 426-band Tanager scene).
</p>

<h3>#4 &mdash; Per-band reflectance uncertainty (<tt>-u</tt> flag)</h3>

<p>
Computes per-pixel reflectance uncertainty (&sigma;_rfl) for each band from
two propagated sources:
</p>
<ol>
  <li><b>Instrument noise</b>: NEDL estimated from the standard deviation of
      the darkest 5&nbsp;% of radiance pixels &rarr; propagated as
      <tt>&sigma;_noise = &pi; &times; NEDL &times; d&sup2; / (E&sub0; &times; cos &theta;_s &times; T_total)</tt></li>
  <li><b>AOD uncertainty</b>: LUT evaluated at <tt>aod &plusmn; 0.04</tt>; half the
      reflectance difference gives &sigma;_aod per pixel.</li>
</ol>
<p>Total: <tt>&sigma;_rfl = &radic;(&sigma;_noise&sup2; + &sigma;_aod&sup2;)</tt></p>
<p>
When <tt>-r</tt> is also enabled, the uncertainty cube feeds the MAP
regularisation as &sigma;_obs&sup2;.
</p>

<h3>#6 &mdash; Model discrepancy noise floor</h3>

<p>
When both <tt>-u</tt> and <tt>-r</tt> are active, a <b>per-band model discrepancy</b>
term is added in quadrature to &sigma;_rfl before MAP regularisation.
It reflects systematic RT model errors:
</p>
<ul>
  <li>Baseline: 0.5&nbsp;% (all bands)</li>
  <li>Gas absorption band edges (720, 760, 940, 1135, 1380, 1850&nbsp;nm):
      +2&nbsp;% Gaussian bump (&sigma;&nbsp;=&nbsp;30&nbsp;nm)</li>
  <li>SWIR &gt;1500&nbsp;nm: +1&nbsp;% (aerosol model uncertainty)</li>
</ul>
<p>
This prevents over-regularisation in bands where the 6SV gas
parameterisation is least accurate.
</p>

<h2>C LIBRARY API (libatcorr.so)</h2>

<p>
<tt>libatcorr.so</tt> exposes the full 6SV2.1 radiative transfer engine as
a C library. The following functions were added in the Phase&nbsp;1&ndash;5
port from the original Fortran code and are available to any caller that
links against the library.
</p>

<h3>Atmosphere profiles</h3>

<p>
Six standard atmosphere models are now fully implemented: US Standard 1962
(<tt>us62</tt>), Mid-latitude Summer (<tt>midsum</tt>), Mid-latitude Winter
(<tt>midwin</tt>), Tropical (<tt>tropical</tt>), Sub-arctic Summer
(<tt>subsum</tt>), and Sub-arctic Winter (<tt>subwin</tt>).
Select via the <tt>atmosphere=</tt> parameter.
</p>

<h3>Utility functions (Phase 2)</h3>

<pre>
/* Solar zenith and azimuth from date / location / time */
void sixs_possol(int month, int jday, float tu,
                 float xlon, float xlat,
                 float *asol, float *phi0, int ia);

/* Chandrasekhar analytical Rayleigh reflectance */
float sixs_chand(float xphi, float xmuv, float xmus, float xtau);

/* Vermote environmental adjacency weighting factors */
void sixs_enviro(float difr, float difa, float r, float palt,
                 float xmuv,
                 float *fra, float *fae, float *fr);
</pre>

<h3>Aerosol vertical profile and surface pressure (Phase 3)</h3>

<pre>
/* Fill ctx-&gt;aerprof with an exponential aerosol layer profile */
void sixs_aeroprof(SixsCtx *ctx, float aod550, float ome,
                   float haa, float alt);

/* Trim the atmosphere profile to a surface pressure (hPa &gt; 0)
   or altitude (km, passed as negative value) */
void sixs_pressure(SixsCtx *ctx, float sp);

/* As above but also returns the trimmed H2O and O3 columns */
void sixs_pressure_columns(SixsCtx *ctx, float sp,
                            float *uw, float *uo3);
</pre>

<h3>Custom Mie aerosol (Phase 4)</h3>

<pre>
/* Compute aerosol single-scattering properties for a log-normal
   size distribution via Bohren&ndash;Huffman Mie scattering.
   Fills ctx-&gt;aer (ext/sca/phase at 20 reference wavelengths). */
void sixs_mie_init(SixsCtx *ctx,
                   double r_mode,   /* mode radius &micro;m         */
                   double sigma_g,  /* geometric std dev       */
                   double m_r_550,  /* real refractive index   */
                   double m_i_550); /* imaginary ref. index    */
</pre>

<p>
Set <tt>LutConfig.aerosol_type = AEROSOL_CUSTOM</tt> (value 9) and call
<tt>sixs_mie_init()</tt> on the per-thread context before computing the LUT
to use a custom particle size distribution.
Typical continental mineral dust values: <tt>r_mode&nbsp;=&nbsp;0.07&nbsp;&micro;m</tt>,
<tt>sigma_g&nbsp;=&nbsp;2.0</tt>, <tt>m_r&nbsp;=&nbsp;1.53</tt>,
<tt>m_i&nbsp;=&nbsp;0.008</tt>.
</p>

<h3>BRDF surface models (Phase 5) and BRDF-RT coupling</h3>

<pre>
#include "brdf.h"

/* Evaluate BRDF at a single (SZA, VZA, RAA) point */
float sixs_brdf_eval(BrdfType type, const BrdfParams *params,
                     float cos_sza, float cos_vza, float raa_deg);

/* Bihemispherical (white-sky) albedo by midpoint quadrature.
 * n_phi=48, n_theta=24 gives &lt; 0.1 % error. */
float sixs_brdf_albe(BrdfType type, const BrdfParams *params,
                     float cos_sza, int n_phi, int n_theta);
</pre>

<p>Available <tt>BrdfType</tt> models:</p>
<table>
<tr><th>Value</th><th>Name</th><th>Description</th></tr>
<tr><td>0</td><td>BRDF_LAMBERTIAN</td><td>Isotropic Lambertian (single &rho;₀ parameter)</td></tr>
<tr><td>1</td><td>BRDF_RAHMAN</td><td>Rahman&ndash;Pinty&ndash;Verstraete (RPV) &mdash; &rho;₀, k, &Theta;</td></tr>
<tr><td>2</td><td>BRDF_ROUJEAN</td><td>Roujean volumetric kernel &mdash; k0, k1, k2</td></tr>
<tr><td>3</td><td>BRDF_HAPKE</td><td>Hapke canopy model &mdash; &omega;, b, c, h</td></tr>
<tr><td>4</td><td>BRDF_OCEAN</td><td>Cox&ndash;Munk glint + whitecaps + water body</td></tr>
<tr><td>5</td><td>BRDF_WALTHALL</td><td>Walthall polynomial &mdash; a0, a1, a2, a3</td></tr>
<tr><td>6</td><td>BRDF_MINNAERT</td><td>Minnaert limb-darkening &mdash; exponent k</td></tr>
<tr><td>7</td><td>BRDF_VERSFELD</td><td>Versfeld (stub &mdash; returns 0)</td></tr>
<tr><td>8</td><td>BRDF_IAPI</td><td>IAPI canopy (stub &mdash; returns 0)</td></tr>
<tr><td>9</td><td>BRDF_ROSSLIMAIGNAN</td><td>Ross&ndash;Li + Maignan hot-spot &mdash; fiso, fvol, fgeo, h_ratio</td></tr>
</table>

<p>
<b>BRDF&ndash;RT coupling</b> is enabled via the <tt>brdf=</tt> and
<tt>brdf_params=</tt> options.  DISCOM always runs with a black lower
boundary; the BRDF model is applied only in the inversion formula.
For Lambertian surfaces (default) the standard <tt>atcorr_invert()</tt>
path is unchanged.  For non-Lambertian surfaces
<tt>atcorr_invert_brdf()</tt> substitutes the bihemispherical (white-sky)
albedo &rho;&macr; in the atmospheric coupling denominator:
</p>
<pre>
  y       = (&rho;_toa &minus; R_atm) / (T_down &times; T_up)
  &rho;_brdf = y &times; (1 &minus; s_alb &times; &rho;&macr;)
</pre>
<p>
&rho;&macr; is computed once per scene via 48&nbsp;&times;&nbsp;24 midpoint
hemisphere quadrature.  The output is the bidirectional reflectance factor
(BRF) at the acquisition geometry.
</p>

<h2>IMAGE-BASED RETRIEVAL OPTIONS</h2>
<p>
<em>i.hyper.atcorr</em> can estimate the atmospheric state parameters directly from
the input hyperspectral cube using the flags <tt>-a</tt>, <tt>-w</tt>, <tt>-z</tt>
and the <tt>dem=</tt> option, making the module fully standalone.  Retrievals
run before LUT computation so that retrieved O<sub>3</sub> and surface pressure
update the LUT; retrieved AOD and H<sub>2</sub>O are used as per-pixel maps.
</p>

<h3>O<sub>3</sub> from Chappuis band depth (<tt>-z</tt>)</h3>
<p>
Scene-mean ozone column is estimated from the Chappuis absorption feature at
~600&nbsp;nm by continuum interpolation between 540 and 680&nbsp;nm:
</p>
<pre>
  L_cont = linear_interp(L_540, L_680) at 600 nm
  D      = max(0, 1 &minus; L_600 / L_cont)
  O3     = D / (&sigma;&sub6;&sub0;&sub0; &times; m)    &sigma;&sub6;&sub0;&sub0; &asymp; 1.0&times;10&sup;&minus;&sup4; DU&sup;&minus;&sup1;
</pre>

<h3>Column water vapour from 940&nbsp;nm (<tt>-w</tt>)</h3>
<p>
Per-pixel WVC is estimated from the 940&nbsp;nm absorption feature using the
Kaufman &amp; Gao (1992) continuum interpolation:
</p>
<pre>
  L_cont = linear_interp(L_865, L_1040) at 940 nm
  D      = max(0, 1 &minus; L_940 / L_cont)
  WVC    = D / (K&sub9;&sub4;&sub0; &times; m)    K&sub9;&sub4;&sub0; = 0.036 cm&sup2;/g
</pre>

<h3>AOD from Dark Dense Vegetation (<tt>-a</tt>)</h3>
<p>
Per-pixel AOD is estimated from DDV pixels (Kaufman et al. 1997).
DDV selection: 0.01 &lt; &rho;_toa(2130) &lt; 0.25 and NDVI(860,660) &gt; 0.1.
Surface prediction: &rho;_surf_470 = 0.25&times;&rho;_2130, &rho;_surf_660 = 0.50&times;&rho;_2130.
Single-scattering inversion using Henyey-Greenstein phase function (g=0.65, &omega;&sub0;=0.89),
scaled to 550&nbsp;nm via the &Aring;ngstr&ouml;m exponent from the 470/660&nbsp;nm pair.
Non-DDV pixels receive the scene-mean AOD.
</p>

<h3>Surface pressure from DEM (<tt>dem=</tt>)</h3>
<p>
The scene-mean terrain elevation from a 2-D raster is converted to surface
pressure using the ISA barometric formula:
<tt>P = 1013.25 &times; (1 &minus; 2.2558&times;10<sup>&minus;5</sup> &times; h)<sup>5.2559</sup></tt>&nbsp;hPa.
</p>

<h2>NOTES</h2>

<h3>LUT file format</h3>
<p>
The binary file is host-endian (little-endian on x86) and has the
following layout:
</p>
<pre>
  magic     uint32   0x4C555400 ("LUT\0")
  version   uint32   1
  n_aod     int32
  n_h2o     int32
  n_wl      int32
  aod[n_aod]          float32
  h2o[n_h2o]          float32
  wl [n_wl]           float32   (micrometres)
  R_atm [n_aod*n_h2o*n_wl]   float32
  T_down[n_aod*n_h2o*n_wl]   float32
  T_up  [n_aod*n_h2o*n_wl]   float32
  s_alb [n_aod*n_h2o*n_wl]   float32
</pre>
<p>
Array indexing is C order: the wavelength index varies fastest.
Typical size: ~4&nbsp;MB for 6&nbsp;AOD &times; 5&nbsp;H<sub>2</sub>O &times; 211&nbsp;wavelengths.
</p>

<h3>Radiative transfer</h3>
<p>
The RT solver is a direct C port of the 6SV2.1 Fortran code (Vermote
et&nbsp;al. 1997). Scattering is computed via the Successive Orders of
Scattering (SOS) method with Gauss&ndash;Legendre quadrature (25 points
per hemisphere, 30 atmospheric layers). Gas absorption (H<sub>2</sub>O,
O<sub>3</sub>, CO<sub>2</sub>, O<sub>2</sub>, N<sub>2</sub>O, CH<sub>4</sub>)
is computed separately and folded into T_down and T_up so that the
scattering LUT only needs to be computed once per AOD value.
</p>

<h3>OpenMP parallelism</h3>
<p>
Each AOD grid point is independent and is computed in a separate OpenMP
thread. On a 4-core machine a 6&nbsp;AOD&nbsp;&times;&nbsp;5&nbsp;H<sub>2</sub>O&nbsp;&times;&nbsp;211&nbsp;band
LUT takes approximately one second. The Gaussian spatial filter, adjacency
correction, uncertainty computation, and MAP regularisation all use
additional OpenMP parallel regions.
</p>

<h3>Cube correction memory</h3>
<p>
When <tt>-r</tt> is active, the full reflectance cube is held in memory for
MAP regularisation. Memory usage is approximately
<tt>n_bands &times; n_pixels &times; 4</tt>&nbsp;bytes. For a 426-band Tanager scene
with a typical 640&nbsp;&times;&nbsp;480 tile this is about 400&nbsp;MB.
When <tt>-r</tt> is not set, bands are written to the output Raster3D
immediately after inversion.
</p>

<h3>Band wavelength metadata</h3>
<p>
When correcting a Raster3D cube the module auto-reads band wavelengths
from <tt>r3.info -h</tt> metadata in the format <tt>Band N: WL nm</tt>.
Make sure this metadata is present in the input cube.
</p>

<h2>EXAMPLES</h2>

<p>
Each example first generates a LUT and then applies it to correct a
Raster3D radiance cube. Scene geometry, atmosphere, and aerosol type are
chosen to reflect realistic acquisition conditions for the land cover and
climate zone described.
</p>

<h3>1. Saharan dust storm (desert, tropical atmosphere)</h3>

<p>
<b>Scene</b>: Algeria, March (DOY 90). High-sun geometry, extremely dry air,
heavy mineral dust load (AOD can exceed 2 during events).
</p>
<pre>
# LUT: wide AOD range to cover moderate and heavy dust episodes
i.hyper.atcorr \
    lut=sahara_dust.lut \
    sza=40 vza=5 raa=150 \
    atmosphere=tropical aerosol=desert ozone=280 \
    aod=0.05,0.2,0.5,1.0,2.0,3.0 \
    h2o=0.2,0.5,1.0,1.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

# Correction with scalar state from an external MODIS dust product
i.hyper.atcorr \
    input=algeria_radiance output=algeria_refl \
    lut=sahara_dust.lut \
    sza=40 vza=5 raa=150 doy=90 \
    aod_val=0.85 h2o_val=0.4 \
    atmosphere=tropical aerosol=desert

# Image-based O3 retrieval (-z) + ISA pressure from DEM.
# -a omitted: barren desert has no DDV-eligible vegetation pixels.
# -w omitted: Saharan H2O &lt; 1.5 g/cm2 is spatially uniform; scalar sufficient.
i.hyper.atcorr -z \
    input=algeria_radiance output=algeria_refl \
    lut=sahara_dust_auto.lut \
    sza=40 vza=5 raa=150 doy=90 \
    atmosphere=tropical aerosol=desert \
    dem=srtm_dem \
    aod=0.05,0.2,0.5,1.0,2.0,3.0 h2o=0.2,0.5,1.0,1.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005
</pre>
<p>
<b>Why <tt>atmosphere=tropical</tt></b>: The tropical profile has the highest
near-surface temperature and pressure, better matching hot Saharan conditions
than the US62 standard. Desert aerosol uses the Shettle/Fenn mineral dust
optical model (strongly wavelength-dependent: high AOD in blue, flatter in
NIR). The narrow H<sub>2</sub>O grid (0.2&ndash;1.5 g/cm&sup2;) reflects
the extremely low precipitable water of the Sahara.
</p>
<p>
<b>Retrieval flags</b>: <tt>-z</tt> retrieves scene-mean O<sub>3</sub> from
the Chappuis absorption band centred at 600 nm. Tropical stratospheric
O<sub>3</sub> deviates &plusmn;30&ndash;50 DU from the 280 DU prior,
introducing a systematic tilt in the 540&ndash;700 nm reflectance if
uncorrected. <tt>dem=</tt> replaces the default 1013.25 hPa with the ISA
formula at the mean terrain elevation; elevated desert plateaux
(e.g. Hoggar massif, ~2&thinsp;000 m, P &asymp; 795 hPa) have ~20&nbsp;%
lower Rayleigh optical depth than sea level. <tt>-a</tt> and <tt>-w</tt>
are omitted: barren desert has no DDV vegetation, and Saharan WVC is
spatially uniform enough for the scalar prior.
</p>

<h3>2. Tropical rainforest (Amazon, high humidity)</h3>

<p>
<b>Scene</b>: Par&aacute; state, Brazil, September (DOY 270). Near-overhead
sun, very high water vapour, background biogenic aerosol.
</p>
<pre>
i.hyper.atcorr \
    lut=amazon.lut \
    sza=28 vza=0 raa=0 \
    atmosphere=tropical aerosol=continental ozone=260 \
    aod=0.03,0.08,0.15,0.30,0.50 \
    h2o=3.5,4.5,5.5,6.5,7.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

# Correction with scalar state (typical wet-season baseline)
i.hyper.atcorr \
    input=amazon_radiance output=amazon_refl \
    lut=amazon.lut \
    sza=28 vza=0 raa=0 doy=270 \
    aod_val=0.10 h2o_val=5.5 \
    atmosphere=tropical aerosol=continental

# Image-based retrieval: per-pixel H2O (-w) + per-pixel AOD (-a) + O3 (-z).
# Dense tropical forest is an ideal DDV target (NDVI &gt; 0.8, rho_2130 ~0.05-0.12).
i.hyper.atcorr -z -w -a \
    input=amazon_radiance output=amazon_refl \
    lut=amazon_auto.lut \
    sza=28 vza=0 raa=0 doy=270 \
    atmosphere=tropical aerosol=continental \
    aod=0.03,0.08,0.15,0.30,0.50 h2o=3.5,4.5,5.5,6.5,7.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005
</pre>
<p>
<b>Why high H<sub>2</sub>O grid</b>: Precipitable water in tropical Amazonia
routinely exceeds 5 g/cm&sup2;. Extending the H<sub>2</sub>O LUT axis above
the default 5 g/cm&sup2; prevents extrapolation error in the 940 nm and
1135 nm water vapour bands, where transmittance is highly nonlinear.
Continental aerosol represents the Aitken-mode biogenic VOC particles typical
of the clean wet season.
</p>
<p>
<b>Retrieval flags</b>: <tt>-w</tt> retrieves per-pixel WVC from the
940 nm band depth; the continental Amazon spans a ~4 g/cm&sup2; WVC gradient
at any given overpass, causing a 5&ndash;12&nbsp;% NIR reflectance error if a
single scalar is used. <tt>-a</tt> exploits dense forest as a DDV target
(&rho;<sub>2130</sub> &asymp; 0.05&ndash;0.12, NDVI &gt; 0.8); per-pixel AOD
from the 470/660 nm pair captures smoke plumes from fire fronts at the forest
edge. <tt>-z</tt> retrieves the tropical O<sub>3</sub> column, which is
~10&ndash;15 DU lower than the mid-latitude standard, preventing a systematic
blue/green reflectance bias.
</p>

<h3>3. Urban temperate mid-winter (continental pollution)</h3>

<p>
<b>Scene</b>: Paris region, France, January (DOY 15). Low sun, cold and dry
air, traffic and heating fuel combustion aerosol, possible anticyclone
pollution build-up.
</p>
<pre>
i.hyper.atcorr \
    lut=paris_winter.lut \
    sza=72 vza=5 raa=120 \
    atmosphere=midwin aerosol=urban ozone=330 \
    aod=0.05,0.15,0.30,0.60,1.00 \
    h2o=0.2,0.4,0.7,1.0 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

# Correction with scalar state + uncertainty output
i.hyper.atcorr -u \
    input=paris_radiance output=paris_refl \
    lut=paris_winter.lut \
    sza=72 vza=5 raa=120 doy=15 \
    aod_val=0.35 h2o_val=0.5 \
    atmosphere=midwin aerosol=urban \
    uncertainty=paris_refl_unc

# Image-based O3 retrieval (-z) + DDV AOD from suburban farmland (-a).
# -w omitted: Paris in January has H2O ~0.2-0.7 g/cm2; scalar is adequate.
i.hyper.atcorr -z -a -u \
    input=paris_radiance output=paris_refl \
    lut=paris_winter_auto.lut \
    sza=72 vza=5 raa=120 doy=15 \
    atmosphere=midwin aerosol=urban \
    uncertainty=paris_refl_unc \
    aod=0.05,0.15,0.30,0.60,1.00 h2o=0.2,0.4,0.7,1.0 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005
</pre>
<p>
<b>Why <tt>atmosphere=midwin</tt> + <tt>aerosol=urban</tt></b>: Mid-latitude
winter profiles have lower water vapour scale heights and a strong temperature
inversion that traps pollution. Urban aerosol contains soot and sulfate
(higher single-scattering absorption, lower SSA than continental), making the
path radiance correction in the visible bands significantly larger than for
clean rural air. The <tt>-u</tt> flag propagates AOD uncertainty (&plusmn;0.04)
into the reflectance product, important here because high SZA inflates the
atmospheric path radiance sensitivity.
</p>
<p>
<b>Retrieval flags</b>: <tt>-z</tt> retrieves scene-mean O<sub>3</sub> from
the Chappuis band; winter mid-latitude O<sub>3</sub> over France ranges
300&ndash;380 DU depending on quasi-biennial oscillation phase and polar
vortex proximity &mdash; a &plusmn;40 DU offset biases 540&ndash;700 nm
reflectance by ~0.5&nbsp;% at SZA=72&deg;. <tt>-a</tt> retrieves per-pixel
AOD using DDV pixels in the agricultural Beauce plain south of Paris (winter
wheat fields, NDVI ~0.3&ndash;0.5); the urban AOD gradient from city centre to
rural fringe spans 0.1&ndash;0.5, so per-pixel retrieval significantly improves
the correction over suburban areas. <tt>-w</tt> is omitted: mid-winter WVC
over northern France is low (0.2&ndash;0.7 g/cm&sup2;) and spatially uniform.
</p>

<h3>4. Coastal temperate mid-summer (maritime aerosol, adjacency correction)</h3>

<p>
<b>Scene</b>: Gulf of Lion, Mediterranean, July (DOY 200). Clean marine air;
land-sea boundary requires adjacency correction.
</p>
<pre>
i.hyper.atcorr \
    lut=mediterranean.lut \
    sza=22 vza=0 raa=0 \
    atmosphere=midsum aerosol=maritime ozone=315 \
    aod=0.02,0.06,0.12,0.20,0.30 \
    h2o=1.5,2.5,3.5,4.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

# Per-pixel atmospheric maps + adjacency correction for land-sea boundary
i.hyper.atcorr -u -r \
    input=med_radiance output=med_refl \
    lut=mediterranean.lut \
    sza=22 vza=0 raa=0 doy=200 \
    atmosphere=midsum aerosol=maritime \
    aod_map=maiac_aod h2o_map=mod05_wvc \
    smooth=2 \
    adj_psf=0.5 \
    uncertainty=med_refl_unc
</pre>
<p>
<b>Why adjacency correction matters here</b>: At a land-sea boundary the
bright land signal bleeds into adjacent water pixels through atmospheric
forward scattering; the diffuse transmittance fraction (~10&ndash;20&nbsp;%
for maritime aerosol at 550 nm) carries the environmental mean reflectance.
<tt>adj_psf=0.5 km</tt> accounts for the typical 500 m scattering radius for
clean marine conditions. Maritime aerosol has low absorption (SSA &asymp; 0.98)
and coarse sea-salt particles that produce strong forward scattering &mdash; the
adjacency radius is larger than for fine-mode aerosol at equivalent AOD.
</p>

<h3>5. Sub-arctic mid-winter with full ISOFIT pipeline</h3>

<p>
<b>Scene</b>: Boreal forest, Northern Sweden, January (DOY 15). Very low sun,
snow-covered ground, clean sub-arctic air.
</p>
<pre>
i.hyper.atcorr \
    lut=sweden_winter.lut \
    sza=78 vza=8 raa=45 \
    atmosphere=subwin aerosol=continental ozone=340 \
    aod=0.01,0.05,0.10,0.20 \
    h2o=0.1,0.3,0.5,0.8 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

i.hyper.atcorr -u -r \
    input=sweden_radiance output=sweden_refl \
    lut=sweden_winter.lut \
    sza=78 vza=8 raa=45 doy=15 \
    atmosphere=subwin aerosol=continental \
    aod_map=maiac_aod h2o_map=mod05_wvc \
    smooth=3 adj_psf=1.0 \
    uncertainty=sweden_refl_unc
</pre>
<p>
<b>Why <tt>atmosphere=subwin</tt></b>: Sub-arctic winter profiles have the
coldest temperature structure and the lowest H<sub>2</sub>O scale height of
the six models, with significant ozone column enhancement. At SZA=78&deg; the
path length is ~5&times; that at nadir, so precise atmosphere profile
selection matters more than at low sun angles. The <tt>-r</tt> MAP
regularisation is especially useful here: bright snow reflectance is nearly
spectrally flat (prior: soil component), which constrains physically
implausible spectral spikes caused by residual gas-correction errors at very
long atmospheric path lengths.
</p>

<h3>6. Sub-arctic mid-summer &mdash; boreal forest</h3>

<p>
<b>Scene</b>: Yukon Territory, Canada, July (DOY 190). Moderate sun, moderate
water vapour from thawed tundra, clean background aerosol.
</p>
<pre>
i.hyper.atcorr \
    lut=yukon_summer.lut \
    sza=45 vza=2 raa=60 \
    atmosphere=subsum aerosol=continental ozone=320 \
    aod=0.02,0.07,0.15,0.30 \
    h2o=0.8,1.5,2.5,3.5 \
    wl_min=0.376 wl_max=2.499 wl_step=0.005

i.hyper.atcorr \
    input=yukon_radiance output=yukon_refl \
    lut=yukon_summer.lut \
    sza=45 vza=2 raa=60 doy=190 \
    aod_val=0.08 h2o_val=2.0 \
    atmosphere=subsum aerosol=continental
</pre>
<p>
<b>Why <tt>atmosphere=subsum</tt></b>: Sub-arctic summer combines moderate
surface temperatures with relatively dry air (H<sub>2</sub>O &lt; 3.5 g/cm&sup2;),
a profile distinct from both the tropical and mid-latitude summer models.
The boreal growing season produces biogenic terpene aerosol well captured by
the continental aerosol model.
</p>

<h3>7. Custom Mie aerosol + BRDF via the C API (Python)</h3>

<p>
The GRASS module exposes five standard aerosol models via <tt>aerosol=</tt>.
For research applications requiring a specific particle size distribution
(e.g. fresh wildfire smoke, mineral dust with a measured size distribution),
use <tt>sixs_mie_init()</tt> through the Python bindings.
</p>

<p><b>Example A: Fresh wildfire smoke over boreal forest</b><br>
Carbonaceous fine-mode particles combined with Ross&ndash;Li&ndash;Maignan
BRDF for the forest canopy.
</p>
<pre>
cfg.aerosol_type  = 9           # AEROSOL_CUSTOM
cfg.mie_r_mode    = 0.08        # mode radius µm (fine carbonaceous)
cfg.mie_sigma_g   = 1.70        # narrow smoke mode
cfg.mie_m_real    = 1.52        # real refractive index at 550 nm
cfg.mie_m_imag    = 0.045       # strong absorption (SSA ≈ 0.87)
cfg.atmosphere_type = 5         # subsum
cfg.brdf_type     = 9           # BRDF_ROSSLIMAIGNAN
cfg.brdf_params   = (0.08, 0.04, 0.01, 2.0, 0, 0)  # fiso, fvol, fgeo, h_ratio
</pre>
<p>
<b>Why this combination</b>: Fresh smoke has much smaller r<sub>mode</sub>
(0.06&ndash;0.10 &micro;m vs 0.15 &micro;m for continental), higher m<sub>i</sub>
(0.03&ndash;0.06 vs 0.001), and &Aring;ngstr&ouml;m exponents of 1.8&ndash;2.2.
Using the wrong aerosol model introduces a systematic positive reflectance
bias of 3&ndash;8&nbsp;% in the blue bands and a negative bias in the NIR.
The Ross&ndash;Li&ndash;Maignan BRDF captures the hotspot reflectance surge of
a closed canopy (forward/backward scattering ratio ~3:1 in NIR); the
Lambertian assumption underestimates hotspot reflectance by 15&ndash;25&nbsp;%.
Correcting both simultaneously avoids double-counting between the aerosol
phase function and the surface anisotropy factor.
</p>

<p><b>Example B: Saharan mineral dust episode over dune fields</b><br>
Coarse calcite/quartz Mie particles combined with Hapke BRDF for bright
desert sand.
</p>
<pre>
cfg.aerosol_type  = 9
cfg.mie_r_mode    = 1.5         # coarse mode radius µm
cfg.mie_sigma_g   = 2.3         # broad bimodal distribution
cfg.mie_m_real    = 1.55        # calcite/quartz
cfg.mie_m_imag    = 0.003       # nearly conservative scattering
cfg.atmosphere_type = 4         # tropical
cfg.brdf_type     = 3           # BRDF_HAPKE
cfg.brdf_params   = (0.88, 0.25, 0.80, 0.48, 0, 0) # omega, b, c, h
</pre>
<p>
<b>Why this combination</b>: Heavy dust events shift the size distribution
toward coarser particles (r<sub>eff</sub> &gt; 2 &micro;m) compared to the
standard Shettle/Fenn desert model (r<sub>eff</sub> &asymp; 0.5 &micro;m,
tuned for background mineral aerosol). Coarser particles have lower
&Aring;ngstr&ouml;m exponent (&alpha; &asymp; 0.1&ndash;0.4), stronger forward
phase function peak, and larger SSA in the blue. Mie modelling with the
measured size distribution reduces the NIR reflectance bias by 5&ndash;12&nbsp;%
for thick dust layers (AOD &gt; 0.8). Desert sand is one of the most
strongly non-Lambertian surfaces; the Hapke opposition surge can add up to
20&nbsp;% to the reflectance near backscatter compared to a Lambertian
assumption.
</p>

<h3>8. Quick test at coarse spectral resolution</h3>
<pre>
i.hyper.atcorr --verbose \
    lut=/tmp/test.lut \
    sza=30 vza=0 raa=0 \
    aod=0.0,0.2,0.4 h2o=2.0,4.0 \
    wl_min=0.4 wl_max=2.5 wl_step=0.05
</pre>

<h2>SEE ALSO</h2>
<em>
<a href="i.hyper.smac.html">i.hyper.smac</a>,
<a href="i.atcorr.html">i.atcorr</a>
</em>

<h2>REFERENCES</h2>
<ul>
<li>Vermote, E.F., Tanr&eacute;, D., Deuz&eacute;, J.L., Herman, M. and Morcrette,
J.J. (1997): Second simulation of the satellite signal in the solar spectrum,
6S: An overview. <em>IEEE Transactions on Geoscience and Remote Sensing</em>,
35(3), 675&ndash;686.</li>
<li>Kotchenova, S.Y., Vermote, E.F., Matarrese, R. and Klemm, F.J. (2006):
Validation of a vector version of the 6S radiative transfer code for
atmospheric correction of satellite data. <em>Applied Optics</em>,
45(26), 6762&ndash;6778.</li>
<li>Thompson, D.R. et al. (2018): Optimal estimation for imaging
spectrometer atmospheric correction. <em>Remote Sensing of Environment</em>,
216, 355&ndash;373. (ISOFIT)</li>
<li>Vermote, E.F., El Saleous, N., Justice, C.O., Kaufman, Y.J.,
Privette, J.L., Remer, L., Roger, J.C. and Tanr&eacute;, D. (1997):
Atmospheric correction of visible to middle-infrared EOS-MODIS data over
land surfaces: Background, operational algorithm and validation.
<em>Journal of Geophysical Research: Atmospheres</em>, 102(D14),
17131&ndash;17141. (adjacency correction)</li>
</ul>

<h2>AUTHORS</h2>
i.hyper.smac project.

<hr class="footer">
<p>
<a href="index.html">Main index</a> |
<a href="imagery.html">Imagery index</a> |
<a href="topics.html">Topics index</a> |
<a href="keywords.html">Keywords index</a> |
<a href="graphical_index.html">Graphical index</a> |
<a href="full_index.html">Full index</a>
</p>
<p>&copy; 2003-2025 <a href="http://grass.osgeo.org">GRASS Development Team</a>,
GRASS GIS 8.5.0dev Reference Manual</p>
</div>
</body>
</html>
